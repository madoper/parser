

# Техническое задание на разработку модуля парсинга сайтов

## 1. Цель и общая концепция

### 1.1. Цель системы
Разработать модуль парсинга сайтов с веб-интерфейсом, обеспечивающий:

- Загрузку и разбор `sitemap.xml`, включая:
  - обычные файлы (`sitemap.xml`, `sitemap_index.xml`)
  - сжатые файлы (`*.xml.gz`, `sitemap_index.xml.gz`)
  - произвольную глубину вложенности sitemap-индексов
- Автоматическое формирование **полного списка страниц** сайта.
- **Просмотр любой страницы** в UI и **интерактивное выделение блоков** для парсинга (CSS‑селекторы).
- Настройку параметров парсинга (таймауты, задержки, ротация отпечатков, ключевые слова/регексы).
- Сохранение данных в **MongoDB** с настраиваемым маппингом полей.
- Ведение **мониторинга** задач парсинга, логов и статистики.

### 1.2. Основные роли

- **Администратор/разработчик** — управляет конфигурацией, доступами, окружением.
- **Аналитик/оператор** — настраивает парсинг, выделяет блоки, настраивает маппинг и запускает задачи, анализирует результаты.

***

## 2. Технологический стек

### 2.1. Backend

- Язык: **Python** (предпочтительно) или Node.js (как альтернатива).
- Фреймворк: **FastAPI** (рекомендуется) или аналогичный (если Node.js — NestJS/Express).
- Библиотеки:
  - HTTP: `aiohttp` или `httpx` (асинхронные), при необходимости `requests` (синхронный).
  - Парсинг HTML/XML: `lxml`, `BeautifulSoup4`.
  - Работа с gzip: стандартный `gzip` модуль.
  - MongoDB: `pymongo` или `motor` (асинхронный).
  - Аутентификация: библиотека для JWT (например, `pyjwt`).

### 2.2. Frontend

- Фреймворк: **React**.
- Язык: TypeScript (желательно).
- Управление состоянием: Redux/Zustand/RTK Query (по выбору команды).
- UI-компоненты: любая библиотека (MUI/Ant Design) + кастомная стилизация под бренд.

### 2.3. База данных

- **MongoDB 4.0+**
  - Отдельные коллекции: `tasks`, `pages`, `rules`, `results`, `logs`, `users` (опционально).

### 2.4. Инфраструктура

- Контейнеризация: Docker + Docker Compose.
- Логи: stdout + ротация логов (log driver / ELK по желанию).
- Env-конфигурация: `.env` файлы, секреты.

***

## 3. Структура интерфейса (вкладки)

1. **Вкладка «Настройка парсинга»**
   - Ввод `sitemap` URL, разбор и построение списка страниц.
   - Просмотр страниц.
   - Интерактивный выбор блоков (CSS‑селекторы).
   - Настройка параметров парсинга.
   - Сбор правил и сохранение конфигурации задачи.

2. **Вкладка «Сохранение»**
   - Настройка маппинга: селектор → поле коллекции MongoDB.
   - Настройки обработки дубликатов.
   - Предпросмотр структуры и тестовое сохранение.

3. **Вкладка «Мониторинг парсинга»**
   - Список задач.
   - Подробная статистика.
   - Просмотр логов.
   - Управление задачами (пауза/стоп/рестарт).
   - Экспорт данных.

***

## 4. Детализация функционала по модулям и подзадачам

### 4.1. Модуль обработки sitemap

#### 4.1.1. Подзадачи

1. Реализовать API:
   - `POST /sitemaps/parse`  
     Вход: URL sitemap.  
     Выход: ID операции, предварительный статус.
   - `GET /sitemaps/{id}`  
     Возвращает состояние разбора и список URL (с пагинацией).

2. Логика обработки:
   - Загрузка файла sitemap по URL.
   - Определение формата:
     - XML
     - `.gz` (gzip)
   - Распаковка `.gz`.
   - Разбор:
     - Обычный sitemap (`urlset` → `<loc>`).
     - sitemap-индекс (`sitemapindex` → `<loc>` → новые sitemap URL).
   - Рекурсивный обход всех вложенных sitemap-индексов до полного списка страниц.

3. Ограничения:
   - Конфигурируемые лимиты на:
     - общее количество URL
     - глубину вложенности.
   - Обработка ошибок:
     - недоступный сайт
     - невалидный XML
     - циклические ссылки на sitemap (защита: set посещенных URLs).

4. Сохранение результата:
   - Коллекция `pages`:
     - `task_id`
     - `url`
     - `status` (initial/not_parsed/parsed/error)
     - `http_status` (если есть)
     - таймстемпы.

#### 4.1.2. Тестирование

- Юнит-тесты:
  - Разбор простого `sitemap.xml`.
  - Разбор `sitemap_index.xml` с несколькими вложенными sitemap.
  - Разбор `.xml.gz` и `sitemap_index.xml.gz`.
  - Обработка некорректного XML.
- Интеграционные тесты:
  - Эмуляция нескольких реальных sitemap-структур.
  - Проверка лимитов и рекурсий.

***

### 4.2. Модуль просмотра списка страниц

#### 4.2.1. Подзадачи

1. API:
   - `GET /tasks/{task_id}/pages`  
     Параметры:
     - пагинация (page, page_size)
     - фильтры (статус, часть URL, маска)
     - сортировка.

2. Frontend:
   - Таблица страниц:
     - колонки: URL, статус, время последней обработки, HTTP-код (если есть).
   - Фильтры:
     - по подстроке в URL
     - по статусу.
   - Массовый выбор страниц:
     - чекбоксы
     - кнопки «выбрать все/снять выбор».

#### 4.2.2. Тестирование

- Юнит-тесты API фильтрации/пагинации.
- Визуальные/ручные тесты:
  - отрисовка длинных списков
  - поведение фильтров и сортировки.

***

### 4.3. Модуль просмотра конкретной страницы и выбора блоков

#### 4.3.1. Подзадачи (Backend)

1. API для получения «снимка» страницы:
   - `GET /pages/{page_id}/snapshot`  
     Действия:
     - загрузка HTML по URL
     - возможная очистка/нормализация (опционально)
     - возвращает чистый HTML (без исполнения JS).

2. Защита:
   - Ограничение времени и количества запросов.
   - Блокировка небезопасного контента (хедеры, CSP).

#### 4.3.2. Подзадачи (Frontend)

1. Компонент просмотрщика страницы:
   - Использование `iframe`/sandbox или рендер DOM-дерева.
   - Отключение внешних скриптов (CSP, sandbox).

2. Режим выбора блоков:
   - Наведение курсора подсвечивает DOM-элемент (рамка/полупрозрачный фон).
   - Клик по элементу:
     - фиксирует выбор
     - вычисляет CSS-селектор (например, библиотека для генерации селекторов).
   - Отображение выбранных блоков в боковой панели:
     - имя блока (редактируемое)
     - CSS-селектор
     - тип контента (текст, HTML, атрибут, например `href`).

3. Предпросмотр данных:
   - Выполнение селектора внутри «снимка» страницы.
   - Показ первых N значений (если множественный селектор).
   - Предупреждения в случае пустого результата.

4. Сохранение правил:
   - `POST /tasks/{task_id}/rules`:
     - `page_pattern` (маска URL или конкретный URL)
     - `rules`: список:
       - `name`
       - `css_selector`
       - `content_type` (text/html/attribute)
       - `attribute_name` (если нужно).
   - `GET /tasks/{task_id}/rules` — просмотр и редактирование.

#### 4.3.3. Тестирование

- Проверка:
  - корректности генерации CSS-селекторов (устойчивая уникальность).
  - корректности подсветки/выбора на сложных DOM.
- Юнит-тесты:
  - применение селектора к сохранённому HTML-снимку.
- Ручные тесты:
  - страницы с таблицами, списками, вложенными блоками.

***

### 4.4. Модуль конфигурации парсинга (параметры запуска)

#### 4.4.1. Подзадачи

1. Параметры задачи:
   - URL sitemap.
   - Диапазон задержек между запросами (min_delay, max_delay).
   - Таймаут (секунды).
   - Лимит параллельных запросов (concurrency).
   - Режим обхода: последовательный/параллельный.
   - User-Agent схемы/пулы.
   - Флаги:
     - проверять `robots.txt`
     - уважать `crawl-delay`.

2. API:
   - `POST /tasks` — создание новой задачи (сохраняет конфигурацию).
   - `GET /tasks/{id}` — чтение конфигурации.

3. UI:
   - Форма конфигурации с валидацией:
     - min_delay < max_delay
     - таймаут > 0
     - URL валидный и т.д.

#### 4.4.2. Тестирование

- Юнит-тесты валидации.
- Ручные тесты формы.

***

### 4.5. Модуль парсинга страниц (исполнитель задач)

#### 4.5.1. Подзадачи

1. Планировщик/воркер:
   - Процесс/сервис, который:
     - берёт задачи типа `task` со статусом `scheduled`.
     - формирует очередь обрабатываемых URL (по `pages`).
     - применяет правила (rules) и извлекает данные.

2. HTTP-запросы:
   - Ротация fingerprint:
     - пул User-Agent.
     - случайный выбор отдельных заголовков.
   - Случайная задержка между запросами:
     - `sleep(random(min_delay, max_delay))`.
   - Таймаут:
     - общий, на соединение+ответ.

3. Соблюдение `robots.txt`:
   - При первом запросе к домену:
     - загрузить `/robots.txt`.
     - разобрать правила для:
       - User-Agent по умолчанию
       - кастомного User-Agent (если задан).
   - При запрете — помечать задачу/URL как запрещённый.

4. Применение CSS-селекторов:
   - Загрузка HTML.
   - Парсинг DOM.
   - Для каждого правила:
     - применить селектор
     - извлечь текст/HTML/атрибуты.
   - Сформировать объект результата:
     - `page_url`
     - поля по маппингу (заполнять частично, если есть ошибки отдельных правил).

5. Обработка ошибок:
   - HTTP ошибки (4xx, 5xx).
   - Таймауты.
   - Ошибки парсинга.
   - Ретрай n раз (по конфигурации или дефолтно).

6. Обновление статусов:
   - В `pages`:
     - `status`: parsed/error/forbidden.
     - `http_status`.
   - В `tasks`:
     - `progress`: процент, количество обработанных страниц.
     - `status`: running/paused/completed/error.

#### 4.5.2. Тестирование

- Нагрузочные тесты:
  - парсинг 10k+ страниц.
- Юнит-тесты для:
  - обработки HTTP ошибок.
  - применения селекторов.
  - логики ретраев.
- Интеграционные:
  - от `task` до сохранения в MongoDB.

***

### 4.6. Модуль сохранения данных в MongoDB

#### 4.6.1. Подзадачи

1. Маппинг:
   - Конфигурация:
     - `collection_name`
     - поле → правило/селектор.
   - Логика:
     - сформировать документ:
       - поля из правил.
       - метаданные:
         - `page_url`
         - `parsed_at`
         - `sitemap_url`
         - `task_id`
         - `parser_version`.

2. Дубликаты:
   - Настройка стратегии:
     - игнорировать, если уже есть по `page_url` или по нестандартному ключу.
     - обновлять существующую запись.
     - создавать новую версию (поле `version` + ссылка на предыдущее `doc_id`).

3. API:
   - `GET /tasks/{task_id}/mapping` — получение схемы маппинга.
   - `POST /tasks/{task_id}/mapping` — сохранение схемы.

4. UI:
   - Конструктор маппинга:
     - выбор коллекции (существующая или новая).
     - сопоставление:
       - поле MongoDB → правило (селектор).
     - предпросмотр:
       - показ нескольких документов, которые будут сохранены.

#### 4.6.2. Тестирование

- Юнит-тесты:
  - формирование документа по маппингу.
  - работа со стратегиями дубликатов.
- Интеграционные:
  - запись в MongoDB, проверка схемы и индексов.

***

### 4.7. Модуль мониторинга и логирования

#### 4.7.1. Подзадачи

1. Логи:
   - Коллекция `logs`:
     - `timestamp`
     - `task_id`
     - `page_url` (опционально)
     - `level` (INFO/WARN/ERROR)
     - `message`
     - `details` (stack trace, HTTP-код и т.п.).

2. Мониторинг задач:
   - API:
     - `GET /tasks` — список задач с краткой инфой.
     - `GET /tasks/{id}/stats` — детальная статистика:
       - всего страниц
       - обработано
       - успешно
       - с ошибками
       - forbidden и пр.
   - UI:
     - таблица задач
     - индикаторы статуса (цветовая схема по статусу)
     - кликабельная деталка задач.

3. Управление задачами:
   - API:
     - `POST /tasks/{id}/pause`
     - `POST /tasks/{id}/resume`
     - `POST /tasks/{id}/stop`.
   - UI:
     - кнопки в таблице задач и на странице деталей.

4. Экспорт:
   - `GET /tasks/{id}/results/export` — экспорт в CSV/JSON.
   - `GET /tasks/{id}/logs/export` — экспорт логов.

#### 4.7.2. Тестирование

- Проверка корректности подсчёта статистики.
- Ручные тесты:
  - поведение задач при паузе/стопе.
- Проверка экспорта (форматы, кодировки).

***

### 4.8. Безопасность и доступ

#### 4.8.1. Подзадачи

1. Аутентификация:
   - JWT или session-based.
   - Роли: admin, user (минимально).

2. Ограничения:
   - Rate limiting для публичных API.
   - Валидация всех входных данных (URL, строки, селекторы).

3. UI:
   - Форма логина.
   - Хранение токена (secure, httpOnly cookie).

#### 4.8.2. Тестирование

- Позитивные и негативные сценарии логина/логаута.
- Проверка доступа к защищённым эндпоинтам.

***

## 5. Порядок реализации (этапы)

### Этап 1. Базовая архитектура и окружение

1. Создание репозитория, базовой структуры проектов (backend + frontend).
2. Настройка Docker/Docker Compose (API + MongoDB + frontend).
3. Настройка CI (минимум — запуск тестов).

### Этап 2. Обработка sitemap и список страниц

1. Backend:
   - Модуль загрузки и разбора sitemap (+ `.gz`, индекс).
   - Модели `Task`, `Page`.
   - API создания задачи и получения списка страниц.
2. Frontend:
   - Форма ввода sitemap URL.
   - Страница со списком страниц (таблица, фильтры).
3. Тестирование модуля sitemap.

### Этап 3. Просмотр страниц и выбор блоков

1. Backend:
   - Эндпоинт получения HTML-снимка страницы.
2. Frontend:
   - Компонент просмотрщика страницы.
   - Интерактивный выбор блоков, генерация и сохранение CSS‑селекторов.
   - UI списка правил.
3. Тестирование выбора блоков и применения селекторов.

### Этап 4. Конфигурация парсинга и маппинг в MongoDB

1. Backend:
   - Конфигурация задачи (таймауты, задержки, concurrency, UA).
   - Модели `Rule`, `Mapping`.
   - Механизм сохранения маппинга в MongoDB.
2. Frontend:
   - Форма настроек парсинга.
   - Конструктор маппинга (селектор → поле MongoDB).
3. Тестирование корректности маппинга.

### Этап 5. Исполнитель парсинга и сохранение результатов

1. Backend:
   - Воркер/сервис выполнения задач.
   - HTTP-клиент с ротацией, задержками, таймаутом, robots.txt.
   - Логика применения правил и сохранения данных.
   - Обновление статусов задач/страниц.
2. Интеграционные тесты:
   - полный цикл от sitemap до MongoDB.

### Этап 6. Мониторинг, логи, управление задачами

1. Backend:
   - Логирование (коллекция `logs`).
   - API статистики и логов.
   - Управление задачами (пауза/стоп/рестарт).
2. Frontend:
   - Вкладка «Мониторинг»:
     - таблица задач
     - детальный просмотр
     - просмотр логов и экспорт.
3. Тестирование мониторинга.

### Этап 7. Безопасность, полировка, документация

1. Внедрение аутентификации и ролевой модели.
2. Дополнительная валидация и rate limiting.
3. Написание документации:
   - для разработчиков (архитектура, API).
   - для пользователей (как настраивать парсинг, правила, маппинг).
4. Финальное тестирование по check‑листу.

***

## 6. Тестирование (общая стратегия)

### 6.1. Уровни тестирования

- **Unit**:
  - обработка sitemap
  - парсинг HTML и селекторы
  - формирование документов MongoDB.
- **Integration**:
  - цепочки: sitemap → pages → rules → parsing → MongoDB.
- **E2E/Functional**:
  - сценарии:
    - настройка задачи
    - выбор блоков
    - запуск парсинга
    - проверка результатов в MongoDB
    - мониторинг и экспорт данных.
- **Performance**:
  - парсинг большого количества страниц (10k+).
  - измерение времени/ресурсов.

### 6.2. Основные сценарии приёмки

1. Сценарий «Простой сайт с одним sitemap.xml».
2. Сценарий «Сайт с sitemap_index.xml + .gz файлами».
3. Сценарий с несколькими правилами на странице (заголовок, текст, ссылки).
4. Сценарий с ошибками HTTP и таймаутами (логика ретраев).
5. Сценарий с дубликатами (проверка стратегий).
6. Сценарий с запретом в `robots.txt`.

***

## 7. Критерии приёмки

- Модуль:
  - корректно обрабатывает sitemap любого типа и глубины вложенности (в пределах настроенных лимитов).
  - отображает полный список страниц и позволяет их фильтровать/выбирать.
  - даёт возможность визуально и интерактивно выбрать блоки на странице и сохранить селекторы.
  - позволяет настроить маппинг в MongoDB и стратегии для дубликатов.
  - выполняет парсинг с учётом таймаутов, задержек, ротации отпечатков и `robots.txt`.
  - предоставляет подробный мониторинг и логи.
  - защищён базовой аутентификацией и валидацией.
- Выполнены и пройдены ключевые сценарии тестирования.

***

Если нужно, могу отдельно:

- развернуть это ТЗ в виде **backlog’а в виде Jira‑эпиков/тасков**,  
- или сделать **структурированную таблицу оценок по подзадачам** (часы/ЧД на каждый блок).